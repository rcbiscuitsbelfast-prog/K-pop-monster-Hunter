name: Auto-Build K-pop Monster Hunter APK

on:
  push:
    branches: [ main, develop, update-game-name ]
  pull_request:
    branches: [ main, develop, update-game-name ]
  workflow_dispatch:

jobs:
  build-apk:
    name: Build and Sign APK
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“± Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: ğŸ¤– Set up Android SDK
      uses: android-actions/setup-android@v2

    - name: ğŸ”§ Make gradlew executable
      run: chmod +x gradlew

    - name: ğŸ“Š Display environment info
      run: |
        echo "ğŸ® Building: K-pop Monster Hunter"
        echo "ğŸ“¦ Version: $(grep 'version =' build.gradle | cut -d"'" -f2)"
        echo "ğŸ”‘ Using public keystore: android/keystore/open-remix.keystore"
        echo "ğŸ“± Target SDK: 30 (Android 11)"
        echo "ğŸ“± Min SDK: 21 (Android 5.0+)"
        echo ""
        echo "ğŸ” Environment check:"
        echo "Java version:"
        java -version
        echo ""
        echo "Gradle version:"
        ./gradlew --version
        echo ""
        echo "Android SDK location: $ANDROID_HOME"
        echo "Keystore exists: $(ls -la android/keystore/open-remix.keystore 2>/dev/null && echo 'YES' || echo 'NO')"

    - name: ğŸ§¹ Clean previous builds
      run: ./gradlew clean

    - name: ğŸ”¨ Build Debug APK
      run: |
        echo "ğŸ—ï¸  Building debug APK..."
        ./gradlew :android:assembleDebug --stacktrace --info --warning-mode all
      continue-on-error: true

    - name: ğŸ”¨ Build Release APK
      run: |
        echo "ğŸ—ï¸  Building release APK..."
        ./gradlew :android:assembleRelease --stacktrace --info --warning-mode all
      continue-on-error: true

    - name: âœ… Check APK files
      run: |
        echo "ğŸ” Checking for APK files..."
        echo "Debug APK:"
        ls -la android/build/outputs/apk/debug/ 2>/dev/null || echo "Debug directory not found"
        echo ""
        echo "Release APK:"
        ls -la android/build/outputs/apk/release/ 2>/dev/null || echo "Release directory not found"
        echo ""
        echo "All build outputs:"
        find android/build/outputs/ -name "*.apk" 2>/dev/null || echo "No APK files found"

    - name: ğŸ“¤ Upload Debug APK
      uses: actions/upload-artifact@v4
      if: hashFiles('android/build/outputs/apk/debug/*.apk') != ''
      with:
        name: K-pop-Monster-Hunter-Debug-APK
        path: android/build/outputs/apk/debug/*.apk
        retention-days: 90

    - name: ğŸ“¤ Upload Release APK
      uses: actions/upload-artifact@v4
      if: hashFiles('android/build/outputs/apk/release/*.apk') != ''
      with:
        name: K-pop-Monster-Hunter-Release-APK
        path: android/build/outputs/apk/release/*.apk
        retention-days: 90

    - name: ğŸ“¤ Upload Build Logs
      uses: actions/upload-artifact@v4
      with:
        name: Build-Logs
        path: |
          android/build/outputs/
          .gradle/
        retention-days: 7

    - name: ğŸ“ Create build summary
      run: |
        cat << EOF > build-summary.md
        # ğŸ® K-pop Monster Hunter - Build Summary
        
        **Version:** ${{ steps.version_info.outputs.version || '1.0.0' }}  
        **Build Date:** $(date -u +'%Y-%m-%d %H:%M UTC')
        
        ## ğŸ” Build Results
        
        Check the artifacts above for APK files and build logs.
        
        ## ğŸš€ Installation Instructions
        
        1. **Download the APK** from the artifacts above
        2. **Enable "Install from unknown sources"** in your Android settings
        3. **Install the APK** on your Android 5.0+ device
        4. **Enjoy the rhythm-based monster hunting!** ğŸµâš”ï¸
        
        ## ğŸµ MIFF Movement
        
        This build is part of the **Make It For Free** movement!
        EOF

    - name: ğŸ“¤ Upload build summary
      uses: actions/upload-artifact@v4
      with:
        name: Build-Summary
        path: build-summary.md
        retention-days: 90