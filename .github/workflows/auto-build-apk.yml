name: Auto-Build K-pop Monster Hunter APK

on:
  push:
    branches: [ main, develop, update-game-name ]
  pull_request:
    branches: [ main, develop, update-game-name ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type (debug/release)'
        required: true
        default: 'release'
        type: choice
        options:
          - debug
          - release

jobs:
  build-apk:
    name: Build and Sign APK
    runs-on: ubuntu-latest
    
    steps:
    - name: 🚀 Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 📱 Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: 🤖 Set up Android SDK
      uses: android-actions/setup-android@v2
      with:
        api-level: '26'
        build-tools: '35.0.0'
        platform: '35'

    - name: 🔧 Make gradlew executable
      run: chmod +x gradlew

    - name: 📊 Display environment info
      run: |
        echo "🎮 Building: K-pop Monster Hunter"
        echo "📦 Version: $(grep 'version =' build.gradle | cut -d"'" -f2)"
        echo "🏗️  Build type: ${{ github.event.inputs.build_type || 'release' }}"
        echo "🔑 Using public keystore: android/keystore/open-remix.keystore"
        echo "📱 Target SDK: 35 (Android 14)"
        echo "📱 Min SDK: 26 (Android 8.0+)"
        echo ""
        echo "🔍 Environment check:"
        echo "Java version:"
        java -version
        echo ""
        echo "Gradle version:"
        ./gradlew --version
        echo ""
        echo "Android SDK location: $ANDROID_HOME"
        echo "Android SDK contents:"
        ls -la $ANDROID_HOME/platforms/ || echo "No platforms found"
        ls -la $ANDROID_HOME/build-tools/ || echo "No build-tools found"
        echo ""
        echo "Keystore exists: $(ls -la android/keystore/open-remix.keystore 2>/dev/null && echo 'YES' || echo 'NO')"



    - name: 🧹 Clean previous builds
      run: ./gradlew --no-daemon clean

    - name: 🔨 Build Debug APK
      run: |
        echo "🏗️  Building debug APK..."
        ./gradlew --no-daemon :android:assembleDebug --stacktrace --info
      continue-on-error: true

    - name: 🔨 Build Release APK
      run: |
        echo "🏗️  Building release APK..."
        ./gradlew --no-daemon :android:assembleRelease --stacktrace --info
      continue-on-error: true

    - name: ✅ Check APK files
      run: |
        echo "🔍 Checking for APK files..."
        echo "Debug APK:"
        ls -la android/build/outputs/apk/debug/ 2>/dev/null || echo "Debug directory not found"
        echo ""
        echo "Release APK:"
        ls -la android/build/outputs/apk/release/ 2>/dev/null || echo "Release directory not found"
        echo ""
        echo "All build outputs:"
        find android/build/outputs/ -name "*.apk" 2>/dev/null || echo "No APK files found"

    - name: 📤 Upload Debug APK
      uses: actions/upload-artifact@v4
      if: hashFiles('android/build/outputs/apk/debug/*.apk') != ''
      with:
        name: K-pop-Monster-Hunter-Debug-APK
        path: android/build/outputs/apk/debug/*.apk
        retention-days: 90

    - name: 📤 Upload Release APK
      uses: actions/upload-artifact@v4
      if: hashFiles('android/build/outputs/apk/release/*.apk') != ''
      with:
        name: K-pop-Monster-Hunter-Release-APK
        path: android/build/outputs/apk/release/*.apk
        retention-days: 90

    - name: 📤 Upload Build Logs
      uses: actions/upload-artifact@v4
      with:
        name: Build-Logs
        path: |
          android/build/outputs/
          .gradle/
        retention-days: 7

    - name: 🏷️ Generate version info
      id: version_info
      run: |
        VERSION=$(grep 'version =' build.gradle | cut -d"'" -f2)
        COMMIT_SHA=$(git rev-parse --short HEAD)
        BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M UTC')
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
        echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
        
        echo "📋 Build Summary:"
        echo "   Version: $VERSION"
        echo "   Commit: $COMMIT_SHA"
        echo "   Date: $BUILD_DATE"

    - name: 📝 Create build summary
      run: |
        cat << EOF > build-summary.md
        # 🎮 K-pop Monster Hunter - Build Summary
        
        ## 📱 APK Build Status
        
        **Version:** ${{ steps.version_info.outputs.version }}  
        **Commit:** ${{ steps.version_info.outputs.commit_sha }}  
        **Build Date:** ${{ steps.version_info.outputs.build_date }}  
        **Build Type:** ${{ github.event.inputs.build_type || 'release' }}
        
        ## 🔍 Build Results
        
        Check the artifacts above for:
        - **Debug APK**: If debug build succeeded
        - **Release APK**: If release build succeeded  
        - **Build Logs**: For detailed build information
        
        ## 🚀 Installation Instructions
        
        1. **Download the APK** from the artifacts above
        2. **Enable "Install from unknown sources"** in your Android settings
        3. **Install the APK** on your Android 8.0+ device
        4. **Enjoy the rhythm-based monster hunting!** 🎵⚔️
        
        ## 🔧 For Remixers
        
        - **Keystore:** Publicly available at \`android/keystore/open-remix.keystore\`
        - **Alias:** \`remixkey\`
        - **Password:** \`remixpass\`
        - **Build Command:** \`./gradlew :android:assembleRelease\`
        
        ## 🎵 MIFF Movement
        
        This build is part of the **Make It For Free** movement - 
        empowering creators to build, share, and remix games without barriers!
        
        ---
        *Built with ❤️ by the open-source community*
        EOF

    - name: 📤 Upload build summary
      uses: actions/upload-artifact@v4
      with:
        name: Build-Summary
        path: build-summary.md
        retention-days: 90

  # Optional: Create GitHub Release for main branch builds
  create-release:
    name: Create Release
    needs: build-apk
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Download APK artifacts
      uses: actions/download-artifact@v4
      with:
        name: K-pop-Monster-Hunter-APK
        path: ./apks

    - name: 📥 Download build summary
      uses: actions/download-artifact@v4
      with:
        name: Build-Summary
        path: ./

    - name: 🏷️ Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.build-apk.outputs.version || '1.0.0' }}
        name: 🎮 K-pop Monster Hunter v${{ needs.build-apk.outputs.version || '1.0.0' }}
        body_path: build-summary.md
        files: |
          apks/android-release.apk
          apks/android-debug.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}