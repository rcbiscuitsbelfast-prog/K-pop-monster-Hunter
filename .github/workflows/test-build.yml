name: Test Build Process

on:
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test-build:
    name: Test APK Build
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“± Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: ğŸ¤– Set up Android SDK
      uses: android-actions/setup-android@v2
      with:
        api-level: '26'
        build-tools: '35.0.0'
        platform: '35'

    - name: ğŸ”§ Make gradlew executable
      run: chmod +x gradlew

    - name: ğŸ“Š Verify keystore
      run: |
        echo "ğŸ”‘ Checking public keystore..."
        if [ -f "android/keystore/open-remix.keystore" ]; then
          echo "âœ… Public keystore found"
          ls -la android/keystore/
        else
          echo "âŒ Public keystore not found!"
          exit 1
        fi

    - name: ğŸ§¹ Clean build
      run: ./gradlew --no-daemon clean

    - name: ğŸ”¨ Test debug build
      run: ./gradlew --no-daemon :android:assembleDebug

    - name: ğŸ”¨ Test release build
      run: ./gradlew --no-daemon :android:assembleRelease

    - name: âœ… Verify APKs
      run: |
        echo "ğŸ” Checking debug APK..."
        if [ -f "android/build/outputs/apk/debug/android-debug.apk" ]; then
          echo "âœ… Debug APK built successfully"
          ls -la android/build/outputs/apk/debug/
        else
          echo "âŒ Debug APK build failed!"
          exit 1
        fi
        
        echo "ğŸ” Checking release APK..."
        if [ -f "android/build/outputs/apk/release/android-release.apk" ]; then
          echo "âœ… Release APK built successfully"
          ls -la android/build/outputs/apk/release/
        else
          echo "âŒ Release APK build failed!"
          exit 1
        fi

    - name: ğŸ“¤ Upload test APKs
      uses: actions/upload-artifact@v4
      with:
        name: Test-Build-APKs
        path: |
          android/build/outputs/apk/debug/android-debug.apk
          android/build/outputs/apk/release/android-release.apk
        retention-days: 7

    - name: ğŸ“ Test summary
      run: |
        echo "ğŸ‰ Test build completed successfully!"
        echo "ğŸ“± Debug APK: android/build/outputs/apk/debug/android-debug.apk"
        echo "ğŸ“± Release APK: android/build/outputs/apk/release/android-release.apk"
        echo "ğŸ”‘ Public keystore: android/keystore/open-remix.keystore"
        echo "ğŸµ MIFF movement principles verified!"