name: Test Build Process

on:
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test-build:
    name: Test APK Build
    runs-on: ubuntu-latest
    
    steps:
    - name: 🚀 Checkout code
      uses: actions/checkout@v4

    - name: 📱 Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: 🤖 Set up Android SDK
      uses: android-actions/setup-android@v2
      with:
        api-level: '26'
        build-tools: '35.0.0'
        platform: '35'

    - name: 🔧 Make gradlew executable
      run: chmod +x gradlew

    - name: 📊 Verify keystore
      run: |
        echo "🔑 Checking public keystore..."
        if [ -f "android/keystore/open-remix.keystore" ]; then
          echo "✅ Public keystore found"
          ls -la android/keystore/
        else
          echo "❌ Public keystore not found!"
          exit 1
        fi

    - name: 🧹 Clean build
      run: ./gradlew --no-daemon clean

    - name: 🔨 Test debug build
      run: ./gradlew --no-daemon :android:assembleDebug

    - name: 🔨 Test release build
      run: ./gradlew --no-daemon :android:assembleRelease

    - name: ✅ Verify APKs
      run: |
        echo "🔍 Checking debug APK..."
        if [ -f "android/build/outputs/apk/debug/android-debug.apk" ]; then
          echo "✅ Debug APK built successfully"
          ls -la android/build/outputs/apk/debug/
        else
          echo "❌ Debug APK build failed!"
          exit 1
        fi
        
        echo "🔍 Checking release APK..."
        if [ -f "android/build/outputs/apk/release/android-release.apk" ]; then
          echo "✅ Release APK built successfully"
          ls -la android/build/outputs/apk/release/
        else
          echo "❌ Release APK build failed!"
          exit 1
        fi

    - name: 📤 Upload test APKs
      uses: actions/upload-artifact@v4
      with:
        name: Test-Build-APKs
        path: |
          android/build/outputs/apk/debug/android-debug.apk
          android/build/outputs/apk/release/android-release.apk
        retention-days: 7

    - name: 📝 Test summary
      run: |
        echo "🎉 Test build completed successfully!"
        echo "📱 Debug APK: android/build/outputs/apk/debug/android-debug.apk"
        echo "📱 Release APK: android/build/outputs/apk/release/android-release.apk"
        echo "🔑 Public keystore: android/keystore/open-remix.keystore"
        echo "🎵 MIFF movement principles verified!"